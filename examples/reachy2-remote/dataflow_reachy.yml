nodes:
  - id: camera
    build: pip install -e ../../node-hub/dora-reachy2
    path: dora-reachy2-camera
    inputs:
      image_left: dora/timer/millis/50
    outputs:
      - image_left
    env:
      # IMAGE_WIDTH: 640
      # IMAGE_HEIGHT: 480
      ROBOT_IP: 172.18.131.66

  - id: reachy-head
    build: pip install -e ../../node-hub/dora-reachy2
    path: dora-reachy2-head
    inputs:
      look: parse_pose/look
    env:
      # IMAGE_WIDTH: 640
      # IMAGE_HEIGHT: 480
      ROBOT_IP: 172.18.131.66

  - id: camera_depth
    build: pip install -e ../../node-hub/dora-reachy2
    path: dora-reachy2-camera
    inputs:
      depth: dora/timer/millis/50
    outputs:
      - depth
      - image_depth
    env:
      # IMAGE_WIDTH: 640
      # IMAGE_HEIGHT: 480
      ROBOT_IP: 172.18.131.66

  - id: reachy-left-arm
    build: pip install -e ../../node-hub/dora-reachy2
    path: dora-reachy2-left-arm
    inputs:
      pose: parse_pose/action_l_arm
    outputs:
      - response_l_arm
    env:
      ROBOT_IP: 172.18.131.66

  - id: reachy-right-arm
    build: pip install -e ../../node-hub/dora-reachy2
    path: dora-reachy2-right-arm
    inputs:
      pose: parse_pose/action_r_arm
    outputs:
      - response_r_arm
    env:
      ROBOT_IP: 172.18.131.66

  - id: reachy-mobile-base
    build: pip install -e ../../node-hub/dora-reachy2
    path: dora-reachy2-mobile-base
    inputs:
      action_base: parse_point/action
      action_whisper: parse_whisper/action
      translate_base: parse_pose/translate_base
    outputs:
      - response_base
    env:
      ROBOT_IP: 172.18.131.66

  - id: dora-microphone
    build: pip install -e ../../node-hub/dora-microphone
    path: dora-microphone
    inputs:
      tick: dora/timer/millis/2000
    outputs:
      - audio

  - id: dora-vad
    build: pip install -e ../../node-hub/dora-vad
    path: dora-vad
    inputs:
      audio: dora-microphone/audio
    outputs:
      - audio

  - id: dora-distil-whisper
    build: pip install -e ../../node-hub/dora-distil-whisper
    path: dora-distil-whisper
    inputs:
      input: dora-vad/audio
    outputs:
      - text
    env:
      TARGET_LANGUAGE: english

  - id: parse_whisper
    path: parse_whisper.py
    inputs:
      text: dora-distil-whisper/text
      arrived: parse_point/arrived
      success: parse_pose/success
    outputs:
      - bbox
      - action
      - points
      - text
      - action_release_left
      - action_release_right
      - follow_pose
      - raise_arm_pose
      - look_ahead
    env:
      IMAGE_RESIZE_RATIO: "1.0"

  - id: dora-qwenvl
    build: pip install -e ../../node-hub/dora-qwen2-5-vl
    path: dora-qwen2-5-vl
    inputs:
      image_left: camera/image_left
      image_depth: camera_depth/image_depth
      text:
        source: parse_whisper/text
        queue_size: 1000
    outputs:
      - text
    env:
      DEFAULT_QUESTION: Output the bounding box of the suitcase.
      IMAGE_RESIZE_RATIO: "1.0"

  - id: parse_bbox
    path: parse_bbox.py
    inputs:
      text: dora-qwenvl/text
      points: parse_whisper/points
    outputs:
      - bbox_track
      - bbox_grab
    env:
      IMAGE_RESIZE_RATIO: "1.0"

  - id: sam2
    build: pip install -e ../../node-hub/dora-sam2
    path: dora-sam2
    inputs:
      image_depth: camera_depth/image_depth
      boxes2d: parse_bbox/bbox_grab
    outputs:
      - masks

  - id: tracker
    build: pip install -e ../../node-hub/dora-cotracker
    path: dora-cotracker
    inputs:
      image: camera/image_left
      boxes2d: parse_bbox/bbox_track
    outputs:
      - tracked_image
      - points
    env:
      INTERACTIVE_MODE: false

  - id: box_coordinates
    build: pip install -e ../../node-hub/dora-object-to-pose
    path: dora-object-to-pose
    inputs:
      depth: camera_depth/depth
      masks: sam2/masks
    outputs:
      - pose

  - id: parse_pose
    path: parse_pose.py
    inputs:
      pose: box_coordinates/pose
      response_r_arm: reachy-right-arm/response_r_arm
      response_l_arm: reachy-left-arm/response_l_arm
      release_left: parse_whisper/action_release_left
      release_right: parse_whisper/action_release_right
      follow_pose: parse_whisper/follow_pose
      raise_arm_pose: parse_whisper/raise_arm_pose
      look_ahead: parse_whisper/look_ahead
      translate_base: reachy-mobile-base/response_base
    outputs:
      - action_r_arm
      - action_l_arm
      - translate_base
      - look
      - success
    env:
      IMAGE_RESIZE_RATIO: "1.0"

  - id: parse_point
    path: parse_point.py
    inputs:
      points: tracker/points
    outputs:
      - action
      - arrived
    env:
      IMAGE_RESIZE_RATIO: "1.0"

  - id: plot
    build: pip install -e ../../node-hub/dora-rerun
    path: dora-rerun
    inputs:
      head/boxes2d: parse_bbox/bbox_track
      head/image: camera/image_left
      torso/image: camera_depth/image_depth
      torso/depth: camera_depth/depth
      torso/boxes2d: parse_bbox/bbox_grab
      torso/masks: sam2/masks
      original_text: dora-distil-whisper/text
      parsed_text: parse_whisper/text
      qwenvl_text: dora-qwenvl/text
      cotracker/tracked_image: tracker/tracked_image
      head/points2d: tracker/points
    env:
      RERUN_MEMORY_LIMIT: 25%
      CAMERA_PITCH: 2.40
